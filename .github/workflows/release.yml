name: Build and Release SCDToolkit

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Download dependencies
      run: |
        # Create directories
        mkdir vgmstream
        mkdir ffmpeg
        
        # Download vgmstream
        Invoke-WebRequest -Uri "https://github.com/vgmstream/vgmstream/releases/latest/download/vgmstream-win64.zip" -OutFile "vgmstream.zip"
        Expand-Archive -Path "vgmstream.zip" -DestinationPath "vgmstream-temp"
        Copy-Item -Path "vgmstream-temp\*" -Destination "vgmstream\" -Recurse -Force
        
        # Download FFmpeg
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg-temp"
        $ffmpegDir = Get-ChildItem -Path "ffmpeg-temp" -Directory | Select-Object -First 1
        Copy-Item -Path "$($ffmpegDir.FullName)\*" -Destination "ffmpeg\" -Recurse -Force
    
    - name: Build executable
      run: |
        # Build the standalone updater first
        Write-Host "Building standalone updater..."
        python -m PyInstaller updater.spec --noconfirm
        
        # Verify updater build worked
        if (-not (Test-Path "dist\updater.exe")) {
            Write-Host "Updater build failed, executable not found"
            exit 1
        }
        
        # Build main application with encrypted PyInstaller
        Write-Host "Building main SCDToolkit application..."
        python -m PyInstaller SCDToolkit.spec --noconfirm
        
        # Verify the main build worked
        if (-not (Test-Path "dist\SCDToolkit\SCDToolkit.exe")) {
            Write-Host "Main application build failed, executable not found"
            exit 1
        }
        
        # Copy updater.exe into the SCDToolkit distribution folder
        Write-Host "Copying updater.exe to SCDToolkit folder..."
        Copy-Item "dist\updater.exe" "dist\SCDToolkit\updater.exe" -Force
        
        # Verify updater was copied
        if (-not (Test-Path "dist\SCDToolkit\updater.exe")) {
            Write-Host "Failed to copy updater.exe to SCDToolkit folder"
            exit 1
        }
        
        Write-Host "Build successful with updater included"
        
    - name: Verify build output
      run: |
        Write-Host "Build completed successfully!"
        Write-Host "Checking build output structure:"
        if (Test-Path "dist\SCDToolkit") {
            Write-Host "Main application files:"
            Get-ChildItem "dist\SCDToolkit" | ForEach-Object { Write-Host "  $_" }
            Write-Host ""
            
            # Verify critical executables exist
            $criticalFiles = @("SCDToolkit.exe", "updater.exe")
            foreach ($file in $criticalFiles) {
                if (Test-Path "dist\SCDToolkit\$file") {
                    Write-Host "✓ $file found"
                } else {
                    Write-Host "✗ $file MISSING!"
                    exit 1
                }
            }
            
            Write-Host ""
            Write-Host "Build size information:"
            $totalSize = (Get-ChildItem "dist\SCDToolkit" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Host "Total build size: $([math]::Round($totalSize, 2)) MB"
        } else {
            Write-Host "ERROR: Build output directory not found!"
            exit 1
        }
        
    - name: Create release package
      run: |
        # Create release directory with clean name
        mkdir SCDToolkit
        
        # Copy the entire PyInstaller onedir output
        Copy-Item -Path "dist\SCDToolkit\*" -Destination "SCDToolkit\" -Recurse -Force
        
    - name: Set version for naming
      id: set_version
      shell: pwsh
      run: |
        # Read __version__ from version.py
        $versionLine = Get-Content version.py | Where-Object { $_ -match '__version__' } | Select-Object -First 1
        if (-not $versionLine) {
          Write-Host "Could not find __version__ in version.py"
          exit 1
        }

        $match = [regex]::Match($versionLine, '"([^"]+)"')
        if (-not $match.Success) {
          Write-Host "Could not parse version string from: $versionLine"
          exit 1
        }

        $version = $match.Groups[1].Value
        Write-Host "Using version from version.py: $version"
        echo "RELEASE_VERSION=$version" >> $env:GITHUB_ENV
    
    - name: Archive Release
      run: |
        # Create ZIP file with clean name (no version number)
        Compress-Archive -Path "SCDToolkit" -DestinationPath "SCDToolkit-Windows.zip"

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SCDToolkit-${{ env.RELEASE_VERSION }}-Windows
        path: SCDToolkit-Windows.zip
        retention-days: 30

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: SCDToolkit-Windows.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
